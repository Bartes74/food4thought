#!/usr/bin/env node

import fetch from 'node-fetch';
import { execSync } from 'child_process';

const API_BASE = 'http://localhost:3001/api';

// Kolory dla konsoli
const colors = {
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  reset: '\x1b[0m',
  bold: '\x1b[1m'
};

const log = (message, color = 'reset') => {
  console.log(`${colors[color]}${message}${colors.reset}`);
};

// Funkcja do rejestracji admina
async function createAdminUser() {
  try {
    log('üîß Tworzenie u≈ºytkownika admin...', 'blue');
    
    const response = await fetch(`${API_BASE}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: 'admin-notifications@test.com',
        password: 'Admin123!',
        confirmPassword: 'Admin123!'
      })
    });

    const data = await response.json();
    
    if (response.ok) {
      log('‚úÖ U≈ºytkownik admin utworzony', 'green');
      
      // Weryfikuj email
      if (data.verificationToken) {
        log('üîó Weryfikowanie email...', 'blue');
        const verifyResponse = await fetch(`${API_BASE}/auth/verify-email?token=${data.verificationToken}`, {
          method: 'GET'
        });
        
        if (verifyResponse.ok) {
          log('‚úÖ Email zweryfikowany', 'green');
        } else {
          const verifyData = await verifyResponse.json();
          log(`‚ùå B≈ÇƒÖd weryfikacji: ${verifyData.error}`, 'red');
        }
      }
      
      return data.user;
    } else {
      log(`‚ùå B≈ÇƒÖd tworzenia u≈ºytkownika: ${data.error}`, 'red');
      return null;
    }
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd: ${error.message}`, 'red');
    return null;
  }
}

// Funkcja do logowania
async function loginUser(email, password) {
  try {
    const response = await fetch(`${API_BASE}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await response.json();
    
    if (response.ok) {
      log('‚úÖ Zalogowano pomy≈õlnie', 'green');
      return data.token;
    } else {
      log(`‚ùå B≈ÇƒÖd logowania: ${data.error}`, 'red');
      return null;
    }
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd: ${error.message}`, 'red');
    return null;
  }
}

// Funkcja do zmiany roli u≈ºytkownika na admin
function makeUserAdmin(userId) {
  try {
    log('üîß Zmiana roli na admin...', 'blue');
    execSync(`sqlite3 data/food4thought.db "UPDATE users SET role = 'admin' WHERE id = ${userId};"`);
    log('‚úÖ Rola zmieniona na admin', 'green');
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd zmiany roli: ${error.message}`, 'red');
  }
}

// Funkcja do tworzenia powiadomienia
async function createNotification(token, title, message) {
  try {
    const response = await fetch(`${API_BASE}/notifications/admin`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ title, message })
    });

    const data = await response.json();
    
    if (response.ok) {
      log('‚úÖ Powiadomienie utworzone', 'green');
      return data;
    } else {
      log(`‚ùå B≈ÇƒÖd tworzenia powiadomienia: ${data.error}`, 'red');
      return null;
    }
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd: ${error.message}`, 'red');
    return null;
  }
}

// Funkcja do pobierania powiadomie≈Ñ admina
async function getAdminNotifications(token) {
  try {
    const response = await fetch(`${API_BASE}/notifications/admin`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();
    
    if (response.ok) {
      log('‚úÖ Pobrano powiadomienia admina', 'green');
      return data;
    } else {
      log(`‚ùå B≈ÇƒÖd pobierania powiadomie≈Ñ: ${data.error}`, 'red');
      return null;
    }
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd: ${error.message}`, 'red');
    return null;
  }
}

// Funkcja do pobierania powiadomie≈Ñ u≈ºytkownika
async function getUserNotifications(token) {
  try {
    const response = await fetch(`${API_BASE}/notifications`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();
    
    if (response.ok) {
      log('‚úÖ Pobrano powiadomienia u≈ºytkownika', 'green');
      return data;
    } else {
      log(`‚ùå B≈ÇƒÖd pobierania powiadomie≈Ñ: ${data.error}`, 'red');
      return null;
    }
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd: ${error.message}`, 'red');
    return null;
  }
}

// Funkcja do rejestrowania wy≈õwietlenia
async function viewNotification(token, notificationId) {
  try {
    const response = await fetch(`${API_BASE}/notifications/${notificationId}/view`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();
    
    if (response.ok) {
      log('‚úÖ Wy≈õwietlenie zarejestrowane', 'green');
      return data;
    } else {
      log(`‚ùå B≈ÇƒÖd rejestrowania wy≈õwietlenia: ${data.error}`, 'red');
      return null;
    }
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd: ${error.message}`, 'red');
    return null;
  }
}

// Funkcja do odrzucania powiadomienia
async function dismissNotification(token, notificationId) {
  try {
    const response = await fetch(`${API_BASE}/notifications/${notificationId}/dismiss`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();
    
    if (response.ok) {
      log('‚úÖ Powiadomienie odrzucone', 'green');
      return data;
    } else {
      log(`‚ùå B≈ÇƒÖd odrzucania powiadomienia: ${data.error}`, 'red');
      return null;
    }
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd: ${error.message}`, 'red');
    return null;
  }
}

// Funkcja do pobierania statystyk powiadomienia
async function getNotificationStats(token, notificationId) {
  try {
    const response = await fetch(`${API_BASE}/notifications/admin/${notificationId}/stats`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    const data = await response.json();
    
    if (response.ok) {
      log('‚úÖ Pobrano statystyki powiadomienia', 'green');
      return data;
    } else {
      log(`‚ùå B≈ÇƒÖd pobierania statystyk: ${data.error}`, 'red');
      return null;
    }
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd: ${error.message}`, 'red');
    return null;
  }
}

// Funkcja do czyszczenia danych testowych
function cleanupTestData() {
  try {
    log('üßπ Czyszczenie danych testowych...', 'yellow');
    execSync(`sqlite3 data/food4thought.db "DELETE FROM notification_stats WHERE notification_id IN (SELECT id FROM admin_notifications WHERE created_by IN (SELECT id FROM users WHERE email LIKE '%test.com'));"`);
    execSync(`sqlite3 data/food4thought.db "DELETE FROM admin_notifications WHERE created_by IN (SELECT id FROM users WHERE email LIKE '%test.com');"`);
    execSync(`sqlite3 data/food4thought.db "DELETE FROM users WHERE email LIKE '%test.com';"`);
    log('‚úÖ Dane testowe wyczyszczone', 'green');
  } catch (error) {
    log(`‚ùå B≈ÇƒÖd czyszczenia: ${error.message}`, 'red');
  }
}

// G≈Ç√≥wna funkcja testowa
async function runTests() {
  log('\nüöÄ Rozpoczynam testy systemu powiadomie≈Ñ...', 'bold');
  
  // Czyszczenie przed testami
  cleanupTestData();
  
  // 1. Tworzenie u≈ºytkownika admin
  const adminUser = await createAdminUser();
  if (!adminUser) {
    log('‚ùå Nie mo≈ºna utworzyƒá u≈ºytkownika admin', 'red');
    return;
  }
  
  // 2. Zmiana roli na admin
  makeUserAdmin(adminUser.id);
  
  // 3. Logowanie admina
  const adminToken = await loginUser('admin-notifications@test.com', 'Admin123!');
  if (!adminToken) {
    log('‚ùå Nie mo≈ºna zalogowaƒá admina', 'red');
    return;
  }
  
  // 4. Tworzenie powiadomienia
  const notification = await createNotification(
    adminToken,
    'Testowe powiadomienie',
    'To jest testowe powiadomienie od administratora. Sprawd≈∫ czy dzia≈Ça poprawnie!'
  );
  
  if (!notification) {
    log('‚ùå Nie mo≈ºna utworzyƒá powiadomienia', 'red');
    return;
  }
  
  // 5. Pobieranie powiadomie≈Ñ admina
  const adminNotifications = await getAdminNotifications(adminToken);
  if (!adminNotifications) {
    log('‚ùå Nie mo≈ºna pobraƒá powiadomie≈Ñ admina', 'red');
    return;
  }
  
  log(`üìä Znaleziono ${adminNotifications.length} powiadomie≈Ñ`, 'blue');
  
  // 6. Tworzenie u≈ºytkownika testowego
  log('\nüë§ Tworzenie u≈ºytkownika testowego...', 'blue');
  const testUserResponse = await fetch(`${API_BASE}/auth/register`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: 'test-user-notifications@test.com',
      password: 'Test123!',
      confirmPassword: 'Test123!'
    })
  });
  
  const testUserData = await testUserResponse.json();
  if (testUserResponse.ok && testUserData.verificationToken) {
    // Weryfikuj email
    log('üîó Weryfikowanie email u≈ºytkownika testowego...', 'blue');
    const verifyResponse = await fetch(`${API_BASE}/auth/verify-email?token=${testUserData.verificationToken}`, {
      method: 'GET'
    });
    
    if (verifyResponse.ok) {
      log('‚úÖ Email u≈ºytkownika testowego zweryfikowany', 'green');
    } else {
      const verifyData = await verifyResponse.json();
      log(`‚ùå B≈ÇƒÖd weryfikacji u≈ºytkownika testowego: ${verifyData.error}`, 'red');
    }
  }
  
  // 7. Logowanie u≈ºytkownika testowego
  const userToken = await loginUser('test-user-notifications@test.com', 'Test123!');
  if (!userToken) {
    log('‚ùå Nie mo≈ºna zalogowaƒá u≈ºytkownika testowego', 'red');
    return;
  }
  
  // 8. Pobieranie powiadomie≈Ñ u≈ºytkownika
  const userNotifications = await getUserNotifications(userToken);
  if (!userNotifications) {
    log('‚ùå Nie mo≈ºna pobraƒá powiadomie≈Ñ u≈ºytkownika', 'red');
    return;
  }
  
  log(`üì± U≈ºytkownik ma ${userNotifications.length} powiadomie≈Ñ`, 'blue');
  
  // 9. Rejestrowanie wy≈õwietlenia
  if (userNotifications.length > 0) {
    await viewNotification(userToken, userNotifications[0].id);
  }
  
  // 10. Odrzucanie powiadomienia
  if (userNotifications.length > 0) {
    await dismissNotification(userToken, userNotifications[0].id);
  }
  
  // 11. Pobieranie statystyk
  if (notification.id) {
    const stats = await getNotificationStats(adminToken, notification.id);
    if (stats) {
      log('\nüìà Statystyki powiadomienia:', 'blue');
      log(`   U≈ºytkownik√≥w: ${stats.summary.total_users}`, 'green');
      log(`   Wy≈õwietle≈Ñ: ${stats.summary.total_views}`, 'green');
      log(`   Odrzuconych: ${stats.summary.dismissed_count}`, 'green');
      log(`   Aktywnych: ${stats.summary.active_users}`, 'green');
      log(`   ≈örednio wy≈õwietle≈Ñ: ${stats.summary.average_views}`, 'green');
    }
  }
  
  // 12. Sprawdzenie czy powiadomienie zosta≈Ço odrzucone
  const updatedUserNotifications = await getUserNotifications(userToken);
  log(`üì± Po odrzuceniu: ${updatedUserNotifications.length} powiadomie≈Ñ`, 'blue');
  
  // Czyszczenie po testach
  cleanupTestData();
  
  log('\nüéâ Testy systemu powiadomie≈Ñ zako≈Ñczone pomy≈õlnie!', 'bold');
}

// Uruchom testy
runTests().catch(error => {
  log(`‚ùå B≈ÇƒÖd podczas test√≥w: ${error.message}`, 'red');
  process.exit(1);
});
